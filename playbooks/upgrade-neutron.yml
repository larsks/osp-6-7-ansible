# # Upgrade Neutron
#
# This playbook updates OpenStack Neutron, using the same process that
# we used for Glance.
#
- hosts: controller
  tags:
    - disable
    - disable-neutron
  pre_tasks:
    - name: prevent pacemaker from managing cleanup actions
      command: pcs resource unmanage {{item}}
      with_items:
        - neutron-ovs-cleanup-clone
        - neutron-netns-cleanup-clone
  roles:
    - role: pcs-stop-prefix
      resource_prefix: neutron
      resource_exclude:
        - neutron-ovs-cleanup-clone
        - neutron-netns-cleanup-clone
        - neutron-scale-clone

- hosts: controller
  tags:
    - packages
  tasks:
    - yum: name={{item}} state=latest
      with_items:
        - openstack-selinux
        - openstack-neutron*
        - python-neutron*
        - dnsmasq
        - openvswitch

# ## Bugfixes
#
- hosts: controller
  tags:
    - bugfix
    - bz1250156
    - bz1250160
    - bz1250164
    - bz1250166
    - bz1250219
    - packages
  tasks:
    - name: "BZ 1250156,1250160,1250164,1250166,1250219: fix neutron dependencies"
      yum: name={{item}} state=latest
      with_items:
        - python-oslo-db
        - python-oslo-messaging
        - python-oslo-i18n
        - python-oslo-config
        - python-oslo-rootwrap

# ## Reload systemd
#
# Package updates may include new systemd unit files, so we make sure
# that systemd is aware of any updated files.
#
- include: reload-systemd.yml

# ## Update database schema
#
- hosts: controller
  tags:
    - database
  tasks:
    - command: >
        openstack-db --service neutron --update
      run_once: true

# ## Update Neutron rootwrap configuration
#
# According to the [Neutron upgrade notes][], the rootwrap `dhcp.filter`
# configuration needs to be edited after upgrading from earlier
# releases.
#
# [neutron upgrade notes]: https://wiki.openstack.org/wiki/ReleaseNotes/Kilo#Upgrade_Notes_6
- hosts: controller
  tasks:
    - name: fix neutron dnsmasq rootwrap filter
      command: >
        sed -i '{{item}}' /usr/share/neutron/rootwrap/dhcp.filters
      with_items:
        - '/^dnsmasq:/ s/: .*/: CommandFilter, dnsmasq, root/'
      run_once: true

# ## Restart Neutron services
#
- hosts: controller
  tags:
    - enable
    - enable-neutron
  roles:
    - role: pcs-start-prefix
      resource_prefix: neutron
      resource_exclude:
        - neutron-ovs-cleanup-clone
        - neutron-netns-cleanup-clone
        - neutron-scale-clone
  tasks:
    - name: allow pacemaker to manage cleanup actions
      command: pcs resource manage {{item}}
      with_items:
        - neutron-ovs-cleanup-clone
        - neutron-netns-cleanup-clone
